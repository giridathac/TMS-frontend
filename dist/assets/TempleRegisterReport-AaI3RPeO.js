import{U as ue,q as ce,e as me,r as b,c as S,C as ve,s as pe,D as ge,h as i,j as k,i as t,z as fe,E as ye,H as be,G as T,t as r,y as xe,w as j,k as W,F as M,l as L,v as Y,V as G,A as we,o as d,n as H}from"./index-Bqden_Qr.js";const he={class:"min-h-screen bg-gray-50"},_e={key:0,class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4"},Se={class:"bg-white shadow-sm border-b border-gray-200 rounded-2xl"},Te={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6"},ke={class:"flex items-center justify-between"},De={class:"text-gray-600 mt-1"},Ie={key:0,class:"text-indigo-600 font-medium"},Ae={key:1,class:"text-indigo-600 font-medium"},Ce={class:"flex items-center space-x-4"},Re={class:"bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-200"},Fe={class:"text-indigo-800 font-medium"},Be={class:"text-indigo-600 text-sm ml-2"},Ve={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},je={class:"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-8"},Me={class:"p-6"},Le={class:"mb-6"},Pe={class:"relative"},Ue=["value"],qe={key:0,class:"mt-2 text-xs text-gray-500"},ze={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},Ee={class:"flex flex-wrap gap-2"},Ne=["onClick","disabled"],$e={class:"flex flex-wrap gap-2"},Oe=["onClick","disabled"],Xe={key:0,class:"mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg"},We={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ye=["disabled","max"],Ge=["disabled","min","max"],He={class:"border-t border-gray-200 pt-6"},Je={class:"flex flex-col md:flex-row md:items-center md:justify-between"},Ke={class:"flex items-center space-x-3"},Qe={class:"relative"},Ze=["disabled"],et=["value"],tt=["disabled"],lt={key:0,class:"animate-spin -ml-1 mr-2 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},st={key:1,class:"mr-2 h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},at={key:1,class:"mt-4 p-4 bg-red-50 border border-red-200 rounded-md"},ot={class:"flex"},nt={class:"ml-3"},rt={class:"mt-1 text-sm text-red-700"},it={class:"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden"},dt={class:"p-6"},ut={class:"flex flex-wrap gap-2"},ct={key:0,class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},mt={class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},vt={class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},pt={key:0},gt={class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},ft={class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},xt={__name:"TempleRegisterReport",setup(yt){const h=ve();we();const u=ue(),B=ce(),{showToast:q}=me(),c=b("all"),v=b("weekly"),x=b("all"),D=b("pdf"),p=b(""),g=b(""),f=b(!1),w=b(""),R=b([]),J=b(!0),K=()=>{const l=new Date,e=new Date;e.setDate(l.getDate()-7),g.value=l.toISOString().split("T"),p.value=e.toISOString().split("T")},z=[{label:"Weekly",value:"weekly"},{label:"Monthly",value:"monthly"},{label:"Yearly",value:"yearly"},{label:"Custom Range",value:"custom"}],E=[{label:"All Status",value:"all"},{label:"Approved",value:"approved"},{label:"Pending",value:"pending"},{label:"Rejected",value:"rejected"}],N=[{label:"PDF",value:"pdf"},{label:"CSV",value:"csv"},{label:"Excel",value:"excel"}],I=S(()=>{var l;return h.query.tenants?h.query.tenants.split(","):h.params.tenantId||((l=B.user)==null?void 0:l.id)||localStorage.getItem("current_tenant_id")}),y=S(()=>h.query.from==="superadmin"),m=S(()=>h.query.tenants?h.query.tenants.split(",").map(l=>l.trim()):[I.value]),Q=S(()=>new Date().toISOString().split("T"));S(()=>c.value==="all"?"all":c.value);const $=S(()=>v.value==="custom"?p.value&&g.value&&new Date(p.value)<=new Date(g.value):!0),A=S(()=>{const l=String(c.value),e=R.value.find(a=>String(a.id)===l);return e||u.temples.find(a=>String(a.id)===l)}),F=S(()=>{let l=[];return y.value&&m.value.length>1?l=R.value:l=u.temples,y.value?l.filter(e=>{const a=String(e.created_by||e.createdBy||""),n=String(e.tenant_id||e.tenantId||e.sourceTenantId||""),s=m.value.some(U=>a===U||n===U),o=(e.status||"").toLowerCase();return s&&(o==="approved"||o==="active")}):l.filter(e=>{const a=(e.status||"").toLowerCase();return a==="approved"||a==="active"})}),Z=l=>{v.value=l,V();const e=new Date,a=new Date;l==="weekly"?a.setDate(e.getDate()-7):l==="monthly"?a.setDate(e.getDate()-30):l==="yearly"&&a.setDate(e.getDate()-365),l!=="custom"&&(p.value=a.toISOString().split("T"),g.value=e.toISOString().split("T"))},ee=l=>{x.value=l,V()},te=()=>{V()},V=()=>{w.value=""},le=l=>{if(l==="all")return"All Temples";const e=String(l),a=R.value.find(s=>String(s.id)===e);if(a)return a.name;const n=u.temples.find(s=>String(s.id)===e);return n?n.name:"Unknown Temple"},se=l=>{const e=z.find(a=>a.value===l);return e?e.label:"Unknown"},ae=l=>{const e=E.find(a=>a.value===l);return e?e.label:"Unknown"},oe=l=>{const e=N.find(a=>a.value===l);return e?e.label:"Unknown"},ne=()=>{var n,s;const l=((n=B.user)==null?void 0:n.roleId)===1||((s=B.user)==null?void 0:s.role)==="superadmin"||y.value||h.path.includes("/superadmin/");let e=null;if(c.value!=="all"&&A.value&&(e=String(A.value.sourceTenantId||A.value.tenant_id||A.value.tenantId||A.value.created_by||A.value.createdBy||"")),l&&m.value.length>1){if(c.value!=="all"&&e){const _={entityId:e,entityIds:[e],tenantId:e,dateRange:v.value,format:D.value,templeId:c.value,isSuperAdmin:!0};return x.value!=="all"&&(_.status=x.value),v.value==="custom"&&(_.startDate=p.value,_.endDate=g.value),_}const o={entityIds:m.value.map(String),dateRange:v.value,format:D.value,templeId:"all",isSuperAdmin:!0};return x.value!=="all"&&(o.status=x.value),v.value==="custom"&&(o.startDate=p.value,o.endDate=g.value),o}const a={entityId:String(I.value),dateRange:v.value,format:D.value,templeId:c.value==="all"?"all":c.value,isSuperAdmin:l};return x.value!=="all"&&(a.status=x.value),v.value==="custom"&&(a.startDate=p.value,a.endDate=g.value),a},re=async()=>{var l,e,a,n;if(!(f.value||!$.value)){V(),f.value=!0;try{const s=ne();c.value!=="all"&&(s.templeId=c.value),y.value||(s.entityId=String(I.value),s.headers={"X-Tenant-ID":String(I.value)});const o=G.validateReportParams({...s,type:"temple-registered"});if(!o.isValid)throw new Error(o.errors.join(", "));const _=await G.downloadTempleRegisteredReport(s);q(`Report downloaded successfully: ${_.filename}`,"success")}catch(s){console.error("Download failed:",s);let o="Failed to download report. Please try again.";(l=s.message)!=null&&l.toLowerCase().includes("network error")?o="Network error. Please check your connection and try again.":((e=s.response)==null?void 0:e.status)===404?o="Report endpoint not found. The report may not be available for this configuration.":((a=s.response)==null?void 0:a.status)===403?o="You do not have permission to download this report.":((n=s.response)==null?void 0:n.status)===400&&(o="Invalid report parameters. Please check your selections."),w.value=o,q(`Download failed: ${o}`,"error")}finally{f.value=!1}}},O=l=>{var n;const e=[],a=new Set;for(const s of l){const o=(n=s.id)==null?void 0:n.toString();o&&(a.has(o)||(a.add(o),e.push(s)))}return e},X=async l=>{try{u.clearTemples?u.clearTemples():u.temples=[];const e=localStorage.getItem("current_tenant_id");localStorage.setItem("current_tenant_id",String(l)),localStorage.setItem("X-Tenant-ID",String(l));try{await u.fetchDirectByTenant(l),(u.temples||[]).length===0&&await u.fetchTemples(l)}catch{await u.fetchTemples(l)}return e?localStorage.setItem("current_tenant_id",e):localStorage.removeItem("current_tenant_id"),localStorage.removeItem("X-Tenant-ID"),(u.temples||[]).map(n=>({...n,sourceTenantId:String(l)}))}catch{return[]}},P=async l=>{if(!l)return[];try{const e={Accept:"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")||""}`,"X-Tenant-ID":String(l)},a=`/api/v1/entities?tenant_id=${l}&_=${Date.now()}`,n=await fetch(a,{method:"GET",headers:e});if(!n.ok)return[];if(!(n.headers.get("content-type")||"").includes("application/json"))return[];const o=await n.json();return(Array.isArray(o)?o:o.data?o.data:o.entities?o.entities:o.items?o.items:[]).filter(C=>{const ie=String(C.created_by||C.createdBy||""),de=String(C.tenant_id||C.tenantId||"");return ie===String(l)||de===String(l)}).map(C=>({...C,sourceTenantId:String(l)}))}catch{return[]}};return pe(async()=>{K();const l=m.value;if(y.value&&m.value.length>1){let e=[];for(const a of m.value){const n=await X(a);if(n.length>0){e.push(...n);continue}const s=await P(a);e.push(...s)}R.value=O(e),F.value.length===0&&(w.value="No approved temples found for the selected tenants.")}else try{if(!l){w.value="Could not determine your tenant ID. Please refresh or contact support.";return}const e=await P(l);e.length>0?u.temples=e:(await u.fetchDirectByTenant(l),(u.temples||[]).length===0&&await u.fetchTemples(l)),F.value.length===0&&(w.value="Could not load temples for your tenant. Please try again later.")}catch{w.value="Failed to load temple data. Some features may not work correctly."}}),ge(()=>h.query.tenants,async()=>{if(y.value&&m.value.length>1){let l=[];for(const e of m.value){const a=await X(e);if(a.length>0){l.push(...a);continue}const n=await P(e);l.push(...n)}R.value=O(l),w.value=F.value.length===0?"No approved temples found for the selected tenants.":"",c.value="all"}}),(l,e)=>{var n;const a=be("router-link");return d(),i("div",he,[y.value?(d(),i("div",_e,[fe(a,{to:"/superadmin/reports",class:"inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"},{default:ye(()=>[...e[4]||(e[4]=[t("svg",{class:"mr-2 h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})],-1),T(" Back to SuperAdmin Reports ",-1)])]),_:1})])):k("",!0),t("div",Se,[t("div",Te,[t("div",ke,[t("div",null,[e[6]||(e[6]=t("h1",{class:"text-2xl font-bold text-gray-900"},"Temple Register Report",-1)),t("p",De,[e[5]||(e[5]=T(" Download registration data for your temples ",-1)),y.value&&m.value.length>1?(d(),i("span",Ie," (Multiple Tenants Selected) ")):I.value?(d(),i("span",Ae," (Tenant ID: "+r(I.value)+") ",1)):k("",!0)])]),t("div",Ce,[t("div",Re,[t("span",Fe,r(((n=xe(B).user)==null?void 0:n.name)||"Tenant User"),1),t("span",Be,r(y.value?"(Super Admin)":"(Tenant)"),1)])])])])]),t("div",Ve,[t("div",je,[e[18]||(e[18]=t("div",{class:"p-6 border-b border-gray-200"},[t("h3",{class:"text-xl font-bold text-gray-900"},"Temple Register"),t("p",{class:"text-gray-600 mt-1"},"Configure filters and download your temple registration data")],-1)),t("div",Me,[t("div",Le,[e[8]||(e[8]=t("label",{class:"block text-gray-700 font-medium mb-2"},"Select Temple",-1)),t("div",Pe,[j(t("select",{"onUpdate:modelValue":e[0]||(e[0]=s=>c.value=s),onChange:te,class:"block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"},[e[7]||(e[7]=t("option",{value:"all"},"All Temples",-1)),(d(!0),i(M,null,L(F.value,s=>(d(),i("option",{key:s.id,value:s.id},r(s.name),9,Ue))),128))],544),[[W,c.value]])]),J.value?(d(),i("div",qe," Found "+r(F.value.length)+" temples for tenant(s): "+r(m.value.join(", ")),1)):k("",!0)]),t("div",ze,[t("div",null,[e[9]||(e[9]=t("label",{class:"block text-gray-700 font-medium mb-2"},"Registration Date",-1)),t("div",Ee,[(d(),i(M,null,L(z,s=>t("button",{key:s.value,onClick:o=>Z(s.value),disabled:f.value,class:H(["px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",v.value===s.value?"bg-indigo-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])},r(s.label),11,Ne)),64))])]),t("div",null,[e[10]||(e[10]=t("label",{class:"block text-gray-700 font-medium mb-2"},"Temple Status",-1)),t("div",$e,[(d(),i(M,null,L(E,s=>t("button",{key:s.value,onClick:o=>ee(s.value),disabled:f.value,class:H(["px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",x.value===s.value?"bg-indigo-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])},r(s.label),11,Oe)),64))])])]),v.value==="custom"?(d(),i("div",Xe,[t("div",We,[t("div",null,[e[11]||(e[11]=t("label",{class:"block text-gray-700 text-sm font-medium mb-2"},"Start Date",-1)),j(t("input",{type:"date","onUpdate:modelValue":e[1]||(e[1]=s=>p.value=s),disabled:f.value,max:g.value,class:"w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"},null,8,Ye),[[Y,p.value]])]),t("div",null,[e[12]||(e[12]=t("label",{class:"block text-gray-700 text-sm font-medium mb-2"},"End Date",-1)),j(t("input",{type:"date","onUpdate:modelValue":e[2]||(e[2]=s=>g.value=s),disabled:f.value,min:p.value,max:Q.value,class:"w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"},null,8,Ge),[[Y,g.value]])])])])):k("",!0),t("div",He,[t("div",Je,[e[15]||(e[15]=t("div",{class:"mb-4 md:mb-0"},[t("h4",{class:"text-lg font-medium text-gray-900"},"Download Report"),t("p",{class:"text-sm text-gray-600"},"Select a format and click download")],-1)),t("div",Ke,[t("div",Qe,[j(t("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>D.value=s),disabled:f.value,class:"block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"},[(d(),i(M,null,L(N,s=>t("option",{key:s.value,value:s.value},r(s.label),9,et)),64))],8,Ze),[[W,D.value]])]),t("button",{onClick:re,disabled:f.value||!$.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"},[f.value?(d(),i("svg",lt,[...e[13]||(e[13]=[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(d(),i("svg",st,[...e[14]||(e[14]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"},null,-1)])])),T(" "+r(f.value?"Downloading...":"Download"),1)],8,tt)])])]),w.value?(d(),i("div",at,[t("div",ot,[e[17]||(e[17]=t("div",{class:"flex-shrink-0"},[t("svg",{class:"h-5 w-5 text-red-400",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})])],-1)),t("div",nt,[e[16]||(e[16]=t("h3",{class:"text-sm font-medium text-red-800"},"Error",-1)),t("p",rt,r(w.value),1)])])])):k("",!0)])]),t("div",it,[t("div",dt,[e[24]||(e[24]=t("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Applied Filters",-1)),t("div",ut,[y.value&&m.value.length>1?(d(),i("div",ct,[e[19]||(e[19]=t("span",{class:"font-medium mr-1"},"Tenants:",-1)),T(" "+r(m.value.length)+" selected ",1)])):k("",!0),t("div",mt,[e[20]||(e[20]=t("span",{class:"font-medium mr-1"},"Temple:",-1)),T(" "+r(c.value==="all"?"All Temples":le(c.value)),1)]),t("div",vt,[e[21]||(e[21]=t("span",{class:"font-medium mr-1"},"Period:",-1)),T(" "+r(se(v.value))+" ",1),v.value==="custom"&&p.value&&g.value?(d(),i("span",pt," ("+r(l.formatDate(p.value))+" - "+r(l.formatDate(g.value))+") ",1)):k("",!0)]),t("div",gt,[e[22]||(e[22]=t("span",{class:"font-medium mr-1"},"Status:",-1)),T(" "+r(ae(x.value)),1)]),t("div",ft,[e[23]||(e[23]=t("span",{class:"font-medium mr-1"},"Format:",-1)),T(" "+r(oe(D.value)),1)])]),e[25]||(e[25]=t("p",{class:"mt-4 text-sm text-gray-600"}," Your report will include data based on the filters above. Click Download to generate and download the report. ",-1))])])])])}}};export{xt as default};
